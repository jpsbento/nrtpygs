# Workflows and Shields

This repository contains github workflows in the ususal `.github/workflows`
location. This is to create a CI/CD workflow.

For information of how the CI/CD workflow is used see
[dev-workflow.md](dev-workflow.md)

## Github secrets
These workflows require secrets to be setup for communication with Slack and
for pushing images to Dockerhub. These can be viewed (but their value hidden)
in the repository Settings Tab. These may have been extended but at the start
there are;
* Dockerhub Username (Doug Arnold's account)
* Dockerhub Password (Doug Arnold's account)
* Slack Webhook (Generated by creating a Slack App)

## Workflow Management and Visualisation
This can be done on the repository Actions Tab.

Workflows are run on the 'runner' (spun up container) which in our case is an
ubuntu system. Then there are a specified number of tasks which are run
through. The workflows use the exit codes of various steps to define a pass
or fail for the action. An exit code of 0 is a pass, any other exit code will
fail the Action and skip the remaining steps (although you can action certain
tasks to run always).

`Pylint` for example is really annoying as any Warning, Codestyle or
Refactoring message will result in a non-zero exit code, and thus fail the
entire run. For this reason we are using Flake8 as a linter.

Workflows can be enabled and disabled via the Actions Tab. A Shield can also be
generated to show whether the Workflow is passing or not. Click on a Workflow
and these options are available in the extras (dots) button by the search bar.

A shield code can then be copied into the README.md for the repository.


## The workflows

All workflows are stored in `.github/workflows/`. If workflows are changed
locally, committed then pushed, you need to explicitly state your github
username and password. Passwords however are becoming depreciated, so you will
need to enable an access token in your account settings (Account Settings -->
Developer Access Settings --> Personal Access Token), to allow Workflow access.

**Issue** - Despite allowing the Personal Access Token workflow priviledges, 
it allows me to push commits with Modified Workflows,
however after a number of pushes / timeout it reverts to rejecting the pushes
again, meaning I need to forget the token and reapply it. Infuriating!

### flake8.yml
A quick Action which is triggered on push or pull on the `main` branch.
It installs flake8 via pip, then run it against the code. This can be modified
to ignore any specific issues that we don't care about. A shield is generated
and in the `README.md`

### primary-workflow.yml
Triggered on a push or pull to the `main` branch. This is the main CI/CD test
which sets up the docker environement and runs docker-compose on the `gsi`
Dockerfile, with a pytest entrypoint. This will start up the `rmq` container
image, and run the pytest tests for the `rcsmq` library within the `gsi`
container image.

If any of the docker-compose system fails or if pytest fails, then there is a
nonzero exit code and the task fails.

This workflow contains two separate ways to message the slack app 'NRTBot'
using the `SLACK_WEBHOOK` secret.
First it informs the `#wp-4-github` slack channel when the Action is triggered,
providing a link to the running Workflow. A second message is sent after the
CI/CD tasks are run informing of the outcome of the Workflow run.


### docker-release.yml
A release action triggered on a release type of `Publish`. This will build
the `gsi` and the `rmq` container and push it to dockerhub tagging both with
`gsi:$release_number` ~ `gsi:latest` and `rcq:$release_number` ~ `rcq:latest`

See [dev-workflow.md](dev-workflow.md) for the release procedure.


## The Shields
Extra shields can be generated and added to the README.md quickly using
https://shields.io/ which can pull information for a various number of
providors. We use the Github Shields to show the Docker version number and
also the size of the image.
